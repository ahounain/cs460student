<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>assignment 5</title>
  <style>
    body { margin: 0; }
    canvas { display: block; }
  </style>
</head>
<body>
 
  <div id = "container">

  </div>

  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@latest/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@latest/examples/jsm/"
      }
    }
    </script>
  <script src = "https://get.goxtk.com/xtk_xdat.gui.js"></script>
  <script src="https://mrdoob.github.io/stats.js/build/stats.min.js"></script>
  <script type = "module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { GLTFLoader } from "three/examples/jsm/loaders/GLTFLoader.js";
import { AnaglyphEffect } from "three/addons/effects/AnaglyphEffect.js";
import { VertexNormalsHelper } from 'three/addons/helpers/VertexNormalsHelper.js';
//import * as dat from 'dat.gui';
/*
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera (
    75,
    window.innerWidth / window.innerHeight,
    0.1,
    1000
);
*/
let renderer, scene, camera, stats;
let effect;
let model, model1;

window['SCENE'] = {
    'anaglyph' : false,
    'poly' : null,
    'rotate_poly' : false,
    'do_rotate_poly': function() {
      window['SCENE']['rotate_poly'] = !window['SCENE']['rotate_poly']
    },
    'blender_old_material': null,
    'change_material': function() {
      if (!window['SCENE']['blender_old_material']) {
window['SCENE']['blender_old_material'] = window['SCENE']['blender'].material.clone();
window['SCENE']['blender'].material = new THREE.MeshNormalMaterial();
} else {
window['SCENE']['blender'].material = window['SCENE']['blender_old_material'].clone();
window['SCENE']['blender_old_material'] = null;
    }
}
}

//const THREE = window.THREE;
//const OrbitControls = window.THREE.OrbitControls;
//const GLTFLoader = window.THREE.GLTFLoader;
///const AnaglyphEffect = window.THREE.AnaglyphEffect;
const dat = window.dat;

function loadFungus() {
  return new Promise((resolve, reject) => {
const loader = new GLTFLoader();

loader.load('poly.glb', (gltf) => {
    model = gltf.scenes[0].children[0];
    
    model.scale.set(10,10,10);
    scene.add(model);
// Now that the model is loaded, you can set window.SCENE.poly
  resolve(model);
    //window.SCENE.poly = model;
  }, undefined, (error) => {
    console.error('error occurred', error);
    reject(error);
  });

loader.load('fungus.glb', (gltf) => {
    model1 = gltf.scenes[0].children[0];
    model1.scale.set(10,20,10);
    model1.position.set(2,0,0);
    scene.add(model1);
    
});
});
}


// initialization
async function init() {
    //renderer
renderer = new THREE.WebGLRenderer();
// set size of renderer
renderer.setSize(window.innerWidth, window.innerHeight);
// add to container div
container.appendChild(renderer.domElement);
//set up stats
stats = new Stats();
container.appendChild( stats.domElement);
// effect setup
effect = new AnaglyphEffect( renderer );
effect.setSize(window.innerWidth, window.innerHeight);
// create scene
scene = new THREE.Scene();
// add in camera
camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 1000);
//camera.position.z = 120;
camera.position.set(0,0,5)
// add in controls
const controls = new OrbitControls (camera, renderer.domElement);
controls.minDistance = 10;
controls.maxDistance = 200;
// add in light
const ambientLight = new THREE.AmbientLight (0x666666)
scene.add(ambientLight);

const dirLight1 = new THREE.DirectionalLight( 0xffddcc, 3 );
        dirLight1.position.set( 1, 0.75, 0.5 );
        scene.add( dirLight1 );
try{
const loadedModel = await loadFungus();
window.SCENE.poly = loadedModel;
console.log(window.SCENE.poly.material);
// create GUI

const gui = new dat.GUI();
const sceneui = gui.addFolder('Scene');
// add x y z controls for lighting

sceneui.add(dirLight1.position, 'x', -100, 100).name('Light X');
sceneui.add(dirLight1.position, 'y', -100, 100).name('Light Y');
sceneui.add(dirLight1.position, 'z', -100, 100).name('Light Z');


  

/*window['SCENE'] = {
    'anaglyph' : false,
    'poly' : null,
    'rotate_poly' : false,
    'do_rotate_poly': function() {
      window['SCENE']['rotate_poly'] = !window['SCENE']['rotate_poly']
    },
}
*/
sceneui.add(window.SCENE, 'anaglyph');
var polyui = gui.addFolder('PolyCam Mesh');
  // wire frame checkbox
  //window.SCENE.poly = model;
  // Check if window.SCENE.poly and its material property exist
//if (window.SCENE.poly && window.SCENE.poly.material) {
  polyui.add(window.SCENE.poly.material, 'wireframe');
//} else {
 // console.error('Model material not found or undefined.');

 // polyui.add(window.SCENE.poly.material, 'wireframe');
  polyui.add(window.SCENE, 'do_rotate_poly').name('rotate!');
  polyui.open();
 
// setting up blender ui
var helper = new VertexNormalsHelper( model1, 0.1, 'blue');
helper.visible = false;
const blenderui = gui.addFolder('Blender');
blenderui.add(helper, 'visible').name('Show normals!');

//animate();
} catch (error) {
  console.error('failed to initialize', error);
}
}
init();
animate();
function animate() {
  
  requestAnimationFrame(animate);
  renderer.render(scene, camera);
  if (window.SCENE.anaglyph) {
    effect.render(scene, camera);
  }
  

  // other stuff...
  if (window.SCENE.poly) {
    if (window.SCENE.rotate_poly) {
      // TODO .. setup 180 degree quaternion
      
      let axis = new THREE.Vector3(0,1,0);
      let angle = Math.PI; // 180 deg
      let q = new THREE.Quaternion();
      q.setFromAxisAngle(axis, angle);
      window.SCENE.poly.quaternion.slerp(q, 0.01);
      window.SCENE.blender_helper.update()


    } else {
      // TODO reset quaternion to identity!
      let q = new THREE.Quaternion();
      q.identity();
      window.SCENE.poly.quaternion.slerp(q, 0.01);
    }
  }
  stats.update();
  // other stuff..
}
/* window.onload = function () {
    animate();
}
*/
  </script>
    
      
  </script>
</body>
</html>

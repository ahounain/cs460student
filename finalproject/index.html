<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8"/>
    <title>simple-viewer</title>
    <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.159.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@<version>/examples/jsm/"
    }
  }
</script>
</head>
<body>
    <canvas id="canvas" style="width: 100%; height: 100%; touch-action: none;" data-engine="three.js r138" __spector_context_type="webgl2" width="1572" height="786"></canvas>

     <script src="three-geo/examples/deps/three/build/three.min.js"></script>
    <script src="three-geo/examples/deps/three/examples/js/controls/OrbitControls.js"></script>
    <script src="three-geo/examples/deps/three/examples/js/libs/stats.min.js"></script>
    
   
    <script src="three-geo/dist/three-geo.min.js"></script>

    <script type="module">
      //import * as THREE from 'three';
import { GLTFExporter } from 'three/examples/jsm/exporters/GLTFExporter.js';
    (async () => {
        THREE.Object3D.DefaultUp = new THREE.Vector3(0, 0, 1);

        const canvas = document.getElementById("canvas");
        const camera = new THREE.PerspectiveCamera(75, canvas.width/canvas.height, 0.1, 1000);
        camera.position.set(0, 0, 1.5);

        const renderer = new THREE.WebGLRenderer({ canvas });
        const controls = new THREE.OrbitControls(camera, renderer.domElement);

        const scene = new THREE.Scene();
        const walls = new THREE.LineSegments(
            new THREE.EdgesGeometry(new THREE.BoxBufferGeometry(1, 1, 1)),
            new THREE.LineBasicMaterial({color: 0xcccccc}));
        walls.position.set(0, 0, 0);
        scene.add(walls);
        scene.add(new THREE.AxesHelper(1));

        const stats = new Stats();
        stats.showPanel(1); // 0: fps, 1: ms, 2: mb, 3+: custom
        document.body.appendChild(stats.dom);
        const render = () => {
            stats.update();
            renderer.render(scene, camera);
        };

        controls.addEventListener('change', render);
        render(); // first time
        const fs = require('fs');
        const txtFile = 'key.txt';

        // Read the file contents
        const ioToken = fs.readFileSync(txtFile, 'utf8');
        

        const tgeo = new ThreeGeo({
            tokenMapbox: ioToken, // <---- set your Mapbox API token here
        });

  

        const terrain = await tgeo.getTerrainRgb(
            [64, -22], // [lat, lng]
            550.0,               // radius of bounding circle (km)
            10);               // zoom resolution

        scene.add(terrain);

const exporter = new GLTFExporter();
const group = new THREE.Group();

terrain.traverse((child) => {
  if (child instanceof THREE.Mesh) {
    group.add(child.clone());
  }
});

exporter.parse(group, function (gltf) {
  const output = JSON.stringify(gltf, null, 2);
  const blob = new Blob([output], {type: 'text/plain'});
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = 'terrain.gltf';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
});

        render();

    
    })();
    </script>
</body>
</html>